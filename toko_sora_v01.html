

<!DOCTYPE html>
<html lang="ja" >

<head>

  <meta charset="UTF-8">
  <title>しくつ君投稿アプリ</title>
  
  
  
  
<style>
@media screen and (min-width: 767px) {

  html{
    align-items: top;
    justify-content: center;
    position: relative;
    height: 100%;
    width: 100%;
    background-color:rgba(0, 150, 200, 0.3);
  }

  body {
    width: 100%;
    font-family: 'Arial', sans-serif;
  }

  #sign-in {
    width: 60%;
    min-width: 150px;
    height: 120px;
    font-size: 24px;
    margin: 35px;
    border-radius: 25px;
  }
  
  #titlePanel {
    display: block;
    height: 80px;
    color: white;
    text-align: center;
    font-size: 18px;
    background-color:rgba(50, 155, 50, 1);
  }

  #formDiv {
    font-size: 14px;
    margin: 10px;
    padding: 0px;
  }

  #completeDiv {
    text-align: center;
    margin: 10px;
    padding: 0px;
  }

  #mapviewDiv {
    padding: 0;
    height: 250px;
    margin:10px;
  }
  #viewmapviewDiv {
    padding: 0;
    height: 250px;
    margin:10px;
  }
  #viewscene {
    padding: 0;
    margin: 0;
    height: 500px;
    width: 100%;
  }
  #sceneviewDiv {
    padding: 0;
    margin: 0;
    height: 100%;
    width: 100%;
  }
  #topbar {
    background: #fff;
    padding: 10px;
  }

  .action-button {
    font-size: 16px;
    background-color: transparent;
    border: 1px solid #d3d3d3;
    color: #6e6e6e;
    height: 32px;
    width: 32px;
    text-align: center;
    box-shadow: 0 0 1px rgba(0, 0, 0, 0.3);
  }

  .action-button:hover,
  .action-button:focus {
    background: #0079c1;
    color: #e4e4e4;
  }

  .active {
    background: #0079c1;
    color: #e4e4e4;
  }
  
  #attachmentlistDiv {
    margin: 20px;
  }
  #gridDiv {
    padding: 0;
    margin:10px;
  }
  #buttonDiv {
    padding: 0;
    display: flex;
    flex-direction: row;
    justify-content: space-evenly;
    margin:20px;
  }
  input[type="text"]{
    width: 99%;
    padding: 10px 15px;
    font-size: 16px;
    border-radius: 3px;
    border: 2px solid #ddd;
    box-sizing: border-box;
  }

  h2 {
    margin: 10px;
  }

  #attachmentDiv {
    margin-left: auto;
    margin-right: auto;
    font-family: Avenir Next W00;
    font-size: 14px;
    margin: 10px;
    padding: 0px;
  }

  .select_attachment {
    background-color: #f0f0f0;
    border-radius: 20px;
    padding: 20px;
    min-height: 300px;
  }

  label{
    color: black;
    font-weight: bold;
  }

  button {
    display: inline-block;
    padding: 0.6em 1em;
    text-decoration: none;
    background: white;
    color: #67c5ff;
    border: solid 2px #67c5ff;
    border-radius: 3px;
    transition: .4s;
    font-size: 14px;
    min-width: 60px;
    height: 40px;
    margin: 5px;
  }

  button:hover {
    background: #67c5ff;
    color: white;
    cursor: pointer;
  }

  input[type="radio"]{
    display: none;
  }

  .attachment {
    box-sizing: border-box;
    cursor: pointer;
    display: inline-block;
    padding: 20px 30px;
    position: relative;
    width: auto;
  }
  .attachment::before {
    background: #fff;
    border: 1px solid #231815;
    border-radius: 50%;
    content: '';
    display: block;
    height: 16px;
    left: 5px;
    margin-top: -8px;
    position: absolute;
    top: 50%;
    width: 16px;
  }
  .attachment::after {
    background: #67c5ff;
    border-radius: 50%;
    content: '';
    display: block;
    height: 10px;
    left: 9px;
    margin-top: -4px;
    opacity: 0;
    position: absolute;
    top: 50%;
    width: 10px;
  }

  input[type=radio]:checked + .attachment::after {
    opacity: 1;
  }

  table{
    width:100%;
    height:100%;
    border: 1px solid #a4a4a4;
    border-collapse: collapse;
  }
  
  tr {
    border: 1px solid #a4a4a4;
    border-collapse: collapse;
  }
  th {
    font-size: 14px;
    text-align: left;
    padding-top: 10px;
    padding-bottom: 10px;
  }

  td {
    background-color:rgba(255, 255, 255, 0.3);
    font-size: 12px;
    padding-top: 10px;
    padding-bottom: 10px;
  }

  thead {
    background: #e9727e;
    color: #fff;
  }
  
  .view_gallery {
    max-width: 100%;
    width: auto;
    max-height: 200px;
    margin : 0 auto;
  }
  
  #footerPanel {
    position: fixed;
    bottom: 0;
    
  }
}


@media screen and (max-width: 767px) {
  html{
    align-items: top;
    justify-content: center;
    position: relative;
    height: 100%;
    width: 100%;
    background-color:rgba(0, 150, 200, 0.3);
  }
  
  body {
    width: 100%;
    padding-bottom: 50px;
    font-family: 'Arial', sans-serif;
  }
  
  #sign-in {
    width: 60%;
    min-width: 150px;
    height:80px;
    font-size: 24px;
    margin: 35px;
    border-radius: 25px;
  }
  
  #titlePanel {
    display: block;
    height: 90px;
    color: white;
    text-align: center;
    font-size: 18px;
    background-color:rgba(50, 155, 50, 1);
  }

  #formDiv {
    font-size: 14px;
    margin: 0px;
    padding: 0px;
  }

  #completeDiv {
    text-align: center;
    margin: 10px;
    padding: 0px;
  }

  #mapviewDiv {
    padding: 0;
    height: 250px;
    margin: 0px;
  }
  #viewmapviewDiv {
    padding: 0;
    height: 250px;
    margin: 0px;
  }
  #viewscene {
    padding: 0;
    margin: 0;
    height: 250px;
  }
  #sceneviewDiv {
    padding: 0;
    margin: 0;
    height: 100%;
    width: 100%;
  }
  #topbar {
    background: #fff;
    padding: 0px;
    margin: 0;
    font-size: 0.5rem;
    text-align: right;
  }

  .action-button {
    font-size: 16px;
    background-color: transparent;
    border: 1px solid #d3d3d3;
    color: #6e6e6e;
    height: 32px;
    width: 32px;
    text-align: center;
    box-shadow: 0 0 1px rgba(0, 0, 0, 0.3);
  }

  .action-button:hover,
  .action-button:focus {
    background: #0079c1;
    color: #e4e4e4;
  }

  .active {
    background: #0079c1;
    color: #e4e4e4;
  }
  #attachmentlistDiv {
    text-align: center;
  }
  #gridDiv {
    padding: 0;
    margin: 0px;
  }
  #buttonDiv {
    padding: 0;
    display: flex;
    flex-direction: row;
    justify-content: space-evenly;
    margin:20px;
  }
  input[type="text"]{
    width: 99%;
    padding: 10px 15px;
    font-size: 16px;
    border-radius: 3px;
    border: 2px solid #ddd;
    box-sizing: border-box;
  }

  h2 {
    margin: 10px;
  }

  #attachmentDiv {
    margin-left: auto;
    margin-right: auto;
    font-size: 9px;
    margin: 0px;
    padding: 0px;
  }

  .select_attachment {
    background-color: #f0f0f0;
    min-height: 300px;
  }

  label{
    color: black;
    font-weight: bold;
  }
  
  img {
    vertical-align: middle;
  }

  button {
    display: inline-block;
    padding: 0.6em 1em;
    text-decoration: none;
    background: white;
    color: #67c5ff;
    border: solid 2px #67c5ff;
    border-radius: 3px;
    transition: .4s;
    font-size: 10px;
    width: auto;
    white-space: nowrap;
    height: auto;
    margin: 5px;
  }

  button:hover {
    background: #67c5ff;
    color: white;
  }

  input[type="radio"]{
    display: none;
  }
  
  input[type="button"]{
    margin-right: 20px;
  }

  .attachment {
    box-sizing: border-box;
    cursor: pointer;
    display: inline-block;
    padding: 20px 30px;
    position: relative;
    width: auto;
  }
  .attachment::before {
    background: #fff;
    border: 1px solid #231815;
    border-radius: 50%;
    content: '';
    display: block;
    height: 16px;
    left: 5px;
    margin-top: -8px;
    position: absolute;
    top: 50%;
    width: 16px;
  }
  .attachment::after {
    background: #67c5ff;
    border-radius: 50%;
    content: '';
    display: block;
    height: 10px;
    left: 9px;
    margin-top: -4px;
    opacity: 0;
    position: absolute;
    top: 50%;
    width: 10px;
  }

  input[type=radio]:checked + .attachment::after {
    opacity: 1;
  }

  thead {
    display: none;
  }
  .histry-table {
    width: 100%;
    padding: 10px;
    font-size: 12px;
  }
  .histry-table tr {
    width: 100%;
    text-align: left;
  }
  .histry-table td {
    display: block;
    text-align: left;
    width: 100%;
    padding-top: 5px;
    padding-bottom: 5px;
  }
  .histry-table td:first-child {
    background: #e9727e;
    color: #fff;
    font-weight: bold;
    text-align: left;
  }
  .histry-table td:before {
    text-align: left;
    content: attr(data-label);
    font-weight: bold;
    min-width: 50px;
  }
  
  .view_gallery {
    max-width: 100%;
    width: auto;
    max-height: 200px;
    margin : 0 auto;
  }
  
  #footerPanel {
    position: fixed;
    bottom: 0;
  }
}
</style>

  
  
  
  

</head>

<body translate="no" >
  <html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>しくつ君投稿アプリ</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.19/esri/css/main.css" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://js.arcgis.com/4.19/"></script>
  </head>

  <body>
    <div id="titlePanel">
      <h2>しくつ君投稿アプリ</h2>
      <span style="float: right;margin: 10px">GEO SEARCH CO.,LTD</span>
    </div>
    <div id="anonymousPanel" style="display: block; padding: 5px;">
      <button id="sign-in" class="sign-in-btn">サインイン</button>

      <div id="helpDiv">
        <label>◆ヘルプ◆</label><br/>
        <span>
          動画サイズは、HD(1280×720)を推奨しています。<br/>
          カメラモードになった時に、「設定」から「サイズ」をご確認ください。<br/>
          （機種により若干設定場所が異なります）<br/>
        </span>
        <br/>
        <label>◆撮影のコツ◆</label><br/>
        <span>
          まず、真上から道路部分を含め撮影し、それから穴の部分を底辺を含め<br/>
          360°撮影するときれいに3D化されます。
        </span>
        <br/>
        <br/>
        <img src="https://taka-github1.github.io/shikutsu/photographer.png" width="250px" height="auto"/>
      </div>
    </div>
    <!--div id="personalizedPanel" style="display: none; padding: 5px; text-align: center;">
      <span id="userId" style="font-weight: bold;"></span>
      <button id="sign-out" class="action">サインアウト</button>
    </div-->
    <div id="mainDiv" style="display: none;">
      <br/>
      <button id="show_form" class="esri-icon-edit" style="margin: 20px">
        投稿する
      </button>
      <br/>
      <table class="histry-table tbl-r05">
        <thead class="thead" id="tableHead" ></thead>
        <tbody class="tbody" id="tableBody"></tbody>
      </table>
      <button id="btn_first" class="esri-icon-beginning"
              onclick="historyTable.firstPage()"></button>
      <button id="btn_prev" class="esri-icon-reverse"
              onclick="historyTable.prevPage()"></button>
      <span class="number-page" id="numberPage">
      </span>

      <button id="btn_next" class="esri-icon-forward"
              onclick="historyTable.nextPage()"></button>
      <button id="btn_last" class="esri-icon-end"
              onclick="historyTable.lastPage()"></button>
    </div>
    <div id="formDiv" style="display: none;">
      <label>会社ID</label><br/><input id="kaishaid" type="text" readonly class="input_text"/><br/><br/>
      <label>タイトル</label><font color="red">*</font><br/><input id="title" type="text" class="input_text"/><br/><br/>
      <label>投稿内容</label><br/><input id="naiyo" type="text" class="input_text"/><br/><br/>
      <label>場所</label><font color="red">*</font><button class="locate_conpact">▲ 閉じる</button><br/>
      <div id="mapviewDiv"></div>
      <div id="gridDiv" style="display:block">場所を指定してください</div>
      <label>住所</label><br/><input id="jusho" type="text" class="input_text"/><br/><br/>
      <label>備考</label><br/><input id="bikou" type="text" class="input_text"/><br/><br/>
      <input id="email" type="text" class="hidden_email" hidden/><br/><br/>

      <div id="attachmentDiv">
        <label>投稿区分</label><br/>
        <input type="radio" name="attachment" id="image" value="image" checked>
        <label for="image" class="attachment">写真</label>
        <input type="radio" name="attachment" id="movie" value="movie">
        <label for="movie" class="attachment">動画</label>
        <div id="upload_images" style="display: block" class="select_attachment">
          <input id="images-select" type="file" accept="image/*" style="display:none;" multiple/>
          <button id="imagebtn">写真の選択</button>
          <label id="images_label"></label><br/>
          <table id="imageGallery_tbl">
            <tr>
              <th style="width:10%;">No</th>
              <th style="width:20%;"></th>
              <th style="width:30%;">ファイル名</th>
              <th style="width:10%;">サイズ</th>
              <th style="width:20%;">状況</th>
              <th style="width:10px;"><center><input class="delbtn" type="button" id="delAllBtn' + count + '" value="全削除" onclick="deleteAllImageRow()"></center></th>
            </tr>
          </table>
        </div>
        <div id="upload_movie" style="display: none" class="select_attachment">
          <table id="movieGallery_tbl">
            <tr>
              <th style="width:150px"></th>
              <th style="width:auto;">ファイル名</th>
              <th style="width:80px;">サイズ</th>
              <th style="width:150px;">状況</th>
            </tr>
            <tr>
              <td><button id="moviebtn1">[１] 選択</button></td>
              <td><span id="movie_filename_1"/></td>
              <td><span id="movie_size_1"/></td>
              <td><span id="movie_status_1"/></td>
            </tr>
            <tr>
              <td><button id="moviebtn2">[２] 選択</button></td>
              <td><span id="movie_filename_2"/></td>
              <td><span id="movie_size_2"/></td>
              <td><span id="movie_status_2"/></td>
            </tr>
            <tr>
              <td><button id="moviebtn3">[３] 選択</button></td>
              <td><span id="movie_filename_3"/></td>
              <td><span id="movie_size_3"/></td>
              <td><span id="movie_status_3"/></td>
            </tr>
          </table>
          <label id="movie_upload_id_1" hidden></label>
          <input id="movie-select1" type="file" accept="video/*" hidden/>
          <label id="movie_upload_id_2" hidden></label>
          <input id="movie-select2" type="file" accept="video/*" hidden/>
          <label id="movie_upload_id_3" hidden></label>
          <input id="movie-select3" type="file" accept="video/*" hidden/>
        </div>
      </div>
      <div id="buttonDiv">
        <button id="sendbtn" style="width:150px;height:40px">送信</button>
        <button id="clearbtn" style="width:150px;height:40px">クリア</button>
        <button class="returnmenu" style="width:150px;height:40px">戻る</button>
      </div>
    </div>
    <div id="completeDiv" style="display: none;">
      <img src="https://taka-github1.github.io/shikutsu/complete.png" width="120px" height="auto"/><br/>
      <h1>正常に投稿されました</h1></br>
    <div id="completebuttonDiv">
      <button class="returnmenu" style="width:150px;height:40px">戻る</button>
    </div>

    </div>
  <div id="viewformDiv" style="display: none;">
    <label>タイトル</label><font color="red">*</font><br/><input id="viewtitle" type="text" class="input_text" disabled/><br/><br/>
    <label>投稿内容</label><br/><input id="viewnaiyo" type="text" class="input_text" disabled/><br/><br/>
    <label>場所</label><font color="red">*</font><button class="locate_conpact">▲ 閉じる</button><br/>
    <div id="viewmapviewDiv"></div>
    <label>住所</label><br/><input id="viewjusho" type="text" class="input_text" disabled/><br/><br/>
    <label>備考</label><br/><input id="viewbikou" type="text" class="input_text" disabled/>
    <input id="viewobjectid" type="text" class="input_text" hidden/>
    <input id="viewscene_itemid" type="text" class="input_text" hidden/>
    <br/><br/>
    <div id="viewheaderbuttonDiv" style="display: flex">
      <button id="editform_show" class="esri-icon-edit">
        登録情報の編集
      </button>
      <button id="edit_send" style="width:150px;height:40px;display: none;">登録</button>
      <button id="edit_cancel" style="width:150px;height:40px;display: none;">キャンセル</button>
    </div>
    <br/><br/>
    <label>３Ｄシーン</label><br/>
    <div id="making_scene" class="esri-icon-time-clock">加工待ち</div>
    <div id="viewscene">
      <div id="sceneviewDiv"></div>
      <div id="topbar">
        <label>計測ツール</label>
        <button class="action-button esri-icon-measure-line"
                id="distanceButton" type="button" title="距離計測"/>
        <button class="action-button esri-icon-measure-area" id="areaButton" type="button" title="面積計測"/>
        <button class="action-button esri-icon-erase" id="clearButton" type="button" title="クリア"/>
        
      </div>
    </div>
    <br/><br/>
    <label>添付ファイル</label><br/>
    <div id="attachmentlistDiv"></div>
    <div id="viewfooterbuttonDiv">
      <button id="addattachment" style="height:40px">添付ファイルの追加(10MB以内)</button>
      <input id="addattachment-select" type="file" accept="*" hidden/>
      <button class="returnmenu" style="width:150px;height:40px">戻る</button>
    </div>
  </div>
  <div id="helpDiv" style="display: none;">
    <h1>
      <img src="https://taka-github1.github.io/shikutsu/help.png" width="40px" height="auto"/>
      ヘルプ
    </h1>
    <span>
      動画サイズは、HD(1280×720)を推奨しています。<br/>
      カメラモードになった時に、「設定」から「サイズ」をご確認ください。<br/>
      （機種により若干設定場所が異なります）<br/>
    </span>
    <br/>
    <label>◆撮影のコツ</label><br/>
    <span>
      まず、真上から道路部分を含め撮影し、それから穴の部分を底辺を含め<br/>
      360°撮影するときれいに3D化されます。
    </span>
    <br/>
    <br/>
    <img src="https://taka-github1.github.io/shikutsu/photographer.png" width="250px" height="auto"/><br/><br/>
    <button class="returnmenu" style="width:150px;height:40px">戻る</button>
  </div>
  <div id="footerPanel" style="display: none;">
    <!--<a href="#" onclick="change_display(9);">しくつ君ヘルプ</a><br/>
    <a target="_blank" href="https://www.geosearch.co.jp/">ジオ・サーチホームページ</a-->
  </div>
  </body>
</html>
  
  
      <script id="rendered-js" >
var webappId = "12BPdduZulYtrkpl";
var push_feature_url = "https://services6.arcgis.com/YweFsHK2qzfki4O5/arcgis/rest/services/SHIKUTSU_FS_SOLA_v01/FeatureServer";

var view_feature_url = "https://services6.arcgis.com/YweFsHK2qzfki4O5/arcgis/rest/services/SHIKUTSU_FS_SOLA_v01/FeatureServer";

var basemap_id = "accf3eff22254ed69e23afeb094a4881";
var basescene_id = "0828bf7e8c1441bfa6ad7d3ae3d14c1f";

var group_id = "0186acf935b348798e3e2e02f1f7b8f9";

var creator_field = "created_user";
var create_date_field = "created_date";

var register_url = push_feature_url + "/uploads/register";

var layer_id = "0";

var token = "";
var email = "";
var portal =null;
var init_latitude = 35.170915;
var init_longitude = 136.8793429;
var latitude = null;
var longitude = null;
var jusho = "";
var view = null;
var viewview = null;
var view_graphic_rendar = null;
var viewview_click = null;

var scene = null;
var sceneview = null;

var chunkSize = 3 * 1024 * 1024;
var locateBtn;
var homeButton;
let activeWidget = null;

var markerSymbol = {
  type: "simple-marker",
  color: [226, 119, 40],
  outline: {
    color: [255, 255, 255],
    width: 2
  }
};

var param = location.search.match(/field:KaishaID=(.*?)(&|$)/);
if (param != null) {
  $('#kaishaid').val(decodeURIComponent(param[1]));
} else {
  $('#kaishaid').val(999999);
}

/*********************初期化処理*********************/

require([
  "esri/portal/Portal",
  "esri/identity/OAuthInfo",
  "esri/identity/IdentityManager",
  "esri/WebMap",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/Graphic",
  "esri/widgets/Locate",
  "esri/widgets/Search",
  "esri/tasks/Locator",
  "esri/WebScene", 
  "esri/views/SceneView", 
  "esri/layers/Layer",
  "esri/layers/PointCloudLayer",
  "esri/layers/IntegratedMeshLayer",
  "esri/widgets/Home",
  "esri/Viewpoint",
  "esri/widgets/DirectLineMeasurement3D",
  "esri/widgets/AreaMeasurement3D"
], function(
        Portal, OAuthInfo, identityManager, 
        WebMap, MapView, FeatureLayer, 
        Graphic, Locate, Search, Locator,
        WebScene, SceneView, Layer, 
        PointCloudLayer, IntegratedMeshLayer, 
        Home, Viewpoint, DirectLineMeasurement3D, AreaMeasurement3D) {

  var portalUrl =  "https://www.arcgis.com/sharing";

  var info = new OAuthInfo({
    appId: webappId,
    popup: false
  });

  identityManager.registerOAuthInfos([info]);

  $('#sign-in').click(function() {
    identityManager.getCredential(portalUrl);
  });

  /*
  $('#sign-out').click(function() {
    identityManager.destroyCredentials();
    window.location.reload();
  });
  */

  identityManager.checkSignInStatus(portalUrl).then(function() {
    $('#anonymousPanel').css('display', 'none');
    //$('#personalizedPanel').css('display', 'block');
    displayForm();
  });

  function displayForm() {
    portal = new Portal();

    portal.load().then(function () {

      //グループに所属しているかのチェック
      portal.user.fetchGroups().then(function(fetchItemResult){
        const match = fetchItemResult.find((group) => {
          return (group.id === group_id);
        });

        if (match == undefined) {
          identityManager.destroyCredentials();
          alert("システムを利用できるユーザではありません");
          $('#anonymousPanel').css('display', 'block');
          //$('#personalizedPanel').css('display', 'none');
          return;
        }

        $('#mainDiv').css('display', 'block');
        $('#formDiv').css('display', 'none');
        $('#completeDiv').css('display', 'none');
        $('#footerPanel').css('display', 'block');
        token = identityManager.credentials[0].token;
        email = portal.user.email
        historyTable.init(identityManager.credentials[0].userId, token);

        initForm();
      });
    });
  }

  function initForm() {
    const map = new WebMap({
      portalItem: {
        id: basemap_id,
      }
    });

    view = new MapView({
      container: "mapviewDiv",
      map: map,
      zoom: 13,
      center: [init_longitude, init_latitude]
    });

    var searchWidget = new Search({
      view: view,
      popupEnabled: false
    });

    view.ui.add(searchWidget, {
      position: "top-right"
    });

    locateBtn = new Locate({
      view: view
    });

    view.ui.add(locateBtn, {
      position: "top-left"
    });

    viewview = new MapView({
      container: "viewmapviewDiv",
      map: map
    });

    var locatorTask = new Locator({
      url: "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer"
    });

    var graphic_rendar = function(lat, long){
      view.graphics.removeAll();
      var pointGraphic = new Graphic({
        geometry: {
          type: "point",
          latitude: lat,
          longitude: long
        }, 
        symbol: markerSymbol
      });
      view.graphics.add(pointGraphic);

      var params = {
        location: pointGraphic.geometry
      };

      latitude = lat;
      longitude = long;

      locatorTask
        .locationToAddress(params)
        .then(function (response) {

        if (response.attributes.CountryCode == "JPN" && response.address != "日本") {
          jusho = response.address;
        } else {
          jusho = "";
        }

        $('#gridDiv').html('緯度:' + Math.round(latitude * 100000) / 100000 + '　経度:' + Math.round(longitude * 100000) / 100000);
        $('#jusho').val(jusho);

      })
        .catch(function (error) {
        jusho = "";
        $('#gridDiv').html('緯度:' + Math.round(latitude * 1000) / 1000 + '<　経度:' + Math.round(longitude * 1000) / 1000);
        $('#jusho').val(jusho);
      });
    }
    
    view_graphic_rendar = function(lat, long){
      viewview.graphics.removeAll();
      var pointGraphic = new Graphic({
        geometry: {
          type: "point",
          latitude: lat,
          longitude: long
        }, 
        symbol: markerSymbol
      });
      viewview.graphics.add(pointGraphic);

      var params = {
        location: pointGraphic.geometry
      };

      latitude = lat;
      longitude = long;

      locatorTask
        .locationToAddress(params)
        .then(function (response) {

        if (response.attributes.CountryCode == "JPN" && response.address != "日本") {
          jusho = response.address;
        } else {
          jusho = "";
        }

        $('#viewjusho').val(jusho);

      })
        .catch(function (error) {
        jusho = "";
        $('#viewjusho').val(jusho);
      });
    }

    //現在地の取得
    view.when(function () {
      if(navigator.geolocation) {
        locateBtn.locate();
      }
    });

    //マップクリック
    view.on("click", function(event){
      var point = event.mapPoint;
      graphic_rendar(point.latitude, point.longitude);
    });

    //住所検索
    searchWidget.on("search-complete", function(event){
      try {
        var geo = event.results[0].results[0].feature.geometry;
        graphic_rendar(geo.latitude, geo.longitude);
      } catch(e) {

      }
    });

    //現在地検索
    locateBtn.on("locate", function(event){
      var cood = event.position.coords;
      graphic_rendar(cood.latitude, cood.longitude);
    });
    
    scene = new WebScene({
      portalItem: {
        id: basescene_id
      }
    });

    sceneview = new SceneView({
      container: "sceneviewDiv",
      map: scene,
      environment: {
        background: {
          type: "color",
          color: [255, 252, 244, 1]
        },
        starsEnabled: false,
        atmosphereEnabled: false
      },
      qualityProfile: "high"
    });


    homeButton = new Home({
      view: sceneview
    });
    sceneview.ui.add(homeButton, "top-left");

    sceneview.ui.add("topbar", "top-right");
    
  }


  /*********************イベント処理*********************/
  $('#show_form').click(function() {
    form_clear();
    change_display(2);
  });

  $('.locate_conpact').click(function() {
    $('#mapviewDiv').toggle(function(){
      if ($(this).is(':visible')){
        $(".locate_conpact").text("▲ 閉じる");
      } else {
        $(".locate_conpact").text("▼ 開く");
      }
    });
    $('#viewmapviewDiv').toggle(function(){
      if ($(this).is(':visible')){
        $(".locate_conpact").text("▲ 閉じる");
      } else {
        $(".locate_conpact").text("▼ 開く");
      }
    });
  });

  //投稿区分の切り替え
  $('input[name="attachment"]:radio').change(function() {
    var type = $(this).val();
    if(type == "image"){
      $('#upload_images').css('display', 'block');
      $('#upload_movie').css('display', 'none');
    }else{
      $('#upload_images').css('display', 'none');
      $('#upload_movie').css('display', 'block');
    }
  });

  //写真選択
  $('#imagebtn').click(function() {
    $('#images-select').click();
  });

  $('#images-select').change(function() {
    handleImageFilesSelect(this.files);
  });

  //動画選択
  $('#moviebtn1').click(function() {
    $('#movie-select1').click();
  });

  $('#moviebtn2').click(function() {
    $('#movie-select2').click();
  });

  $('#moviebtn3').click(function() {
    $('#movie-select3').click();
  });

  $('#movie-select1').change(function() {
    movieFilesSelect(this.files[0], 1);
  });

  $('#movie-select2').change(function() {
    movieFilesSelect(this.files[0], 2);
  });

  $('#movie-select3').change(function() {
    movieFilesSelect(this.files[0], 3);
  });

  //送信ボタンクリック
  $('#sendbtn').click(function() {
    var kaishaid = $('#kaishaid').val();

    if (kaishaid == "") {
      alert("会社IDが指定されていないため送信できません");
      return;
    }

    var title = $('#title').val();

    if (title == "") {
      alert("タイトルは必須です");
      $('#title').focus();
      return;
    }

    var attachment = $('input[name="attachment"]:checked').val();

    //アタッチメントの選択チェック
    if (attachment == "image") {
      var objTBL = document.getElementById("imageGallery_tbl");
      var count = objTBL.rows.length-1;
      if (count == 0){
        alert("写真が選択されていません");
        return;
      }
    } else {
      var movie_upload_id_1 = $('#movie_upload_id_1').textContent;
      var movie_upload_id_2 = $('#movie_upload_id_2').textContent;
      var movie_upload_id_3 = $('#movie_upload_id_3').textContent;
      if (movie_upload_id_1 == "" && movie_upload_id_2 == "" && movie_upload_id_3=="") {
        alert("動画が選択されていません");
        return;
      }
    }

    //現在地の指定チェック
    if (latitude == null || longitude == null){
      alert("場所が指定されていません");
      return;
    }
    $('#sendbtn').html("送信中");

    add_feature(latitude, longitude, attachment);

  });

  //クリアボタンクリック
  $('#clearbtn').click(function() {
    form_clear();
  });

  //メイン画面に戻るボタンクリック
  $('.returnmenu').click(function() {
    historyTable.refreshRow();
    setActiveWidget(null);
    change_display(1);
  });

  //フォームに戻る
  $('#input_form').click(function() {
    form_clear();
    change_display(2);
    $('#completeDiv').css('display', 'none');
  });
  
  //登録情報の編集画面を表示
  $('#editform_show').click(function() {
    change_view_enable(true);
  });
  
  //編集のキャンセル
  $('#edit_cancel').click(function() {
    change_view_enable(false);
  });
  
  //登録情報の編集確定
  $('#edit_send').click(function() {
    var title = $('#viewtitle').val();
    if (title == "") {
      alert("タイトルは必須です");
      $('#viewtitle').focus();
      return;
    }
    edit_feature(latitude, longitude);
  });
  
  //距離計測ボタン
  $('#distanceButton').click(function(event) {
    setActiveWidget(null);
    const elements = $('.active');
    for (let i = 0; i < elements.length; i++) {
      elements[i].classList.remove("active");
    }
    
    if (!event.target.classList.contains("active")) {
      setActiveWidget("distance");
    } else {
      setActiveButton(null);
    }
  });
  
  //面積計測ボタン
  $('#areaButton').click(function(event) {
    setActiveWidget(null);
    const elements = $('.active');
    for (let i = 0; i < elements.length; i++) {
      elements[i].classList.remove("active");
    }
    
    if (!event.target.classList.contains("active")) {
      setActiveWidget("area");
    } else {
      setActiveButton(null);
    }
  });
  
  //計測クリアボタン
  $('#clearButton').click(function(event) {
    setActiveWidget(null);
    const elements = $('.active');
    for (let i = 0; i < elements.length; i++) {
      elements[i].classList.remove("active");
    }
  });
  
  
  //添付ファイルの追加
  $('#addattachment').click(function() {
    $('#addattachment-select').click();
  });
  
  $('#addattachment-select').change(function() {
    //movieFilesSelect(this.files[0], 1);
    
    addattachent_upload_file($('#viewobjectid').val(), this.files[0])
  });

  /*********************ロジック処理*********************/

  async function  handleImageFilesSelect(files) {
    
    //入力不可に設定
    form_disabled(true);

    for (var i = 0, f; f = files[i]; i++) {
      var objTBL = document.getElementById("imageGallery_tbl");
      if (!objTBL)
        return;

      var count = objTBL.rows.length;

      // 最終行に新しい行を追加
      var row = objTBL.insertRow(count);

      await compact_image(f, count, row);

      $('#images_label').html(count + "件の写真が選択されました");
    }

    $('input[type=file]').val('');
  }

  async function compact_image(f, count, row) {

    await wait(1);

    var c1 = row.insertCell(0);
    var c2 = row.insertCell(1);
    var c3 = row.insertCell(2);
    var c4 = row.insertCell(3);
    var c5 = row.insertCell(4);
    var c6 = row.insertCell(5);

    c1.innerHTML = '<center><span class="seqno">' + count + '</span></center>';
    c3.innerHTML = f.name;
    c5.innerHTML = '<span class="status">読込中</span>';
    c6.innerHTML = '<center><input class="delbtn" type="button" id="delBtn' + count + '" value="削除" onclick="deleteImageRow(this)"></center>';
    
    var file_property_bag = {
      type: f.type
    };

    const reader = new FileReader();
    const imgReader = new Image();
    const imgWidth = 960;
    reader.onloadend = () => {
      imgReader.onload = () => {
        const imgType = imgReader.src.substring(5, imgReader.src.indexOf(';'));
        const imgHeight = imgReader.height * (imgWidth / imgReader.width);
        const canvas = document.createElement('canvas');
        canvas.width = imgWidth;
        canvas.height = imgHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(imgReader,0,0,imgWidth,imgHeight);

        canvas.toBlob(async function (blob) {
          var url = URL.createObjectURL(blob);

          c2.innerHTML = '<center><img class="thumb" loading="lazy" height="30px" src="' + url +
            '" title="' + f.name + '"/></center>';
          c4.innerHTML =(Math.floor(blob.size/1024/1024*100)/100) + "MB"
          c5.innerHTML = '<span class="upload_id" hidden></span><span class="status"></span>';

          await upload_rowimage(row, file_property_bag);
        });


      }
      imgReader.src = reader.result;
    }
    reader.readAsDataURL(f);

  }

  async function upload_rowimage(row, file_property_bag) {
    var filename = row.children[2].innerText;
    var url = row.children[1].firstElementChild.firstElementChild.src;

    var upload_id_span = row.getElementsByClassName('upload_id')[0];
    var status_span = row.getElementsByClassName('status')[0];

    async function getImageData(url, filename, upload_id_span, status_span) {
      status_span.innerText = "0%";

      const res = await fetch(url);
      const blob = await res.blob();

      url = push_feature_url + "/uploads/upload";

      var upload_file = new File([blob], filename, file_property_bag);

      var form = new FormData();
      form.set('f','json');
      form.set('file', upload_file);
      form.set('token', token);

      await $.ajax({
        url: url,
        type: "POST",
        data: form,
        processData: false,
        contentType: false,
        dataType: 'json',
        context: status_span,
        async: true,
        xhr : function(){
          var XHR = $.ajaxSettings.xhr();
          XHR.upload.addEventListener('progress',function(e){
            var progre = parseInt(e.loaded/e.total * 100);
            status_span.innerText = "" + progre + "%";
          });
          return XHR;
        },
        success: function(data) {
          status_span.innerText = "送信済";
          upload_id_span.innerText = data.item.itemID;
          
          if (check_image_upload() == true) {
            //入力可に設定
            form_disabled(false);
          }
          console.log(status_span + ":" + data.item.itemID);
        },
        error: function(data) {
          console.log(data);
        }
      });
    }
    await getImageData(url, filename, upload_id_span, status_span);
  }
  
  function check_image_upload() {
    var objTBL = document.getElementById("imageGallery_tbl");
    var tableRows = objTBL.getElementsByTagName('tr');

    for (var i = 1; i < tableRows.length; i++) {
      if (tableRows[i].getElementsByClassName('status')[0] == null) {
        continue;
      }
      if (tableRows[i].getElementsByClassName('status')[0].innerText != "送信済") {
        return false;
      }
    }
    return true;
  }

  function  movieFilesSelect(file, index) {
    //入力不可に設定
    form_disabled(true);

    var str_index = String(index);

    $('#movie_filename_' + str_index).html(file.name);
    $('#movie_size_' 
      + str_index).html((Math.floor(file.size/1024/1024*100)/100) + "MB");

    registerBlobData(file, index)
    $('input[type=file]').val('');

  }

  function registerBlobData(f, index) {

    var form = new FormData();
    form.set('f','json');
    form.set('itemName', f.name);
    form.set('token', token);

    $.ajax({
      url: register_url,
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: false
    }).done(function(data) {
      uploadBlobData(data.item.itemID, f, index);
    }).fail(function(data) {
      console.log(data);
    });
  }

  async function uploadBlobData(upload_id, file, index) {

    var str_index = String(index);

    var part_url = push_feature_url + "/uploads/" + upload_id + "/uploadPart";
    var commit_url = push_feature_url + "/uploads/" + upload_id + "/commit";

    var totalBytes = file.size;

    // チャンク分割数
    var chunkCount = Math.ceil(totalBytes / chunkSize);

    var readBytes = 0;
    var tasks = [];
    var end_task = [];

    var reader = new FileReader();
    reader.onloadend = function(evt) {
      if (evt.target.readyState != FileReader.DONE) {
        return;
      }

      var binaryData = evt.target.result;

      var file_property_bag = {
        type: file.type
      };

      var items = [];
      for(let i = 0; i < chunkCount; i++){
        var blob = null;

        if (i == chunkCount-1){
          blob = binaryData.slice(readBytes, totalBytes);
        } else{
          blob = binaryData.slice(readBytes, readBytes + chunkSize);
        }
        readBytes = readBytes + chunkSize;

        var cut_file = new File([blob], file.name, file_property_bag);

        items.push({
          index: i,
          file: cut_file,
          progre: 0,
          status: 0
        });
      }

      upload_parts_func = (datas, callback) => {
        let count = 0;
        let done = 0;

        let upload_part_func = async (count) => {
          let data = datas[count];

          if (count > 1) {
            while (datas[count-1].status == 0){
              await wait(0.5);
            }
          }

          var form = new FormData();
          form.set('f','json');
          form.set('partId', data.index);
          form.set('file', data.file);
          form.set('token', token);

          var promise = $.ajax({
            url: part_url,
            enctype: 'multipart/form-data',
            type: "POST",
            data: form,
            processData: false,
            contentType: false,
            dataType: 'json',
            async: true,
            //context: data.index,
            xhr : function(){
              var XHR = $.ajaxSettings.xhr();
              XHR.upload.addEventListener('progress',function(e){
                var progre = parseInt(e.loaded/e.total * 100);

                datas[count].progre = progre;
                console.log("upload_part_func progre:index" + datas[count].index + ":" + datas[count].progre + "%");

                var stop_status = 100 * datas.length;
                var sum_status = 0;
                for (i=0;i<datas.length;i++) {
                  sum_status = sum_status + datas[i].progre;
                }
                progre = parseInt(sum_status/stop_status * 100);
                $('#movie_status_' + str_index).html("" + progre + "%");
              });
              return XHR;
            },
            success: function(data) {
              console.log("upload_part_func end:index" + datas[count].index);

              datas[count].status = 1;

              var cnt = 0;
              for (i=0;i<datas.length;i++) {
                cnt = cnt + datas[i].status;
              }

              if (cnt == datas.length) {
                callback();
              }
            },
            error: function(data) {
              console.log(data);
            }
          });

          if (count >= datas.length - 1) {
            return;
          }

          upload_part_func(count + 1);
        };

        upload_part_func(count);
      };

      upload_parts_func(items, () => commitBlobData(upload_id, index));
    }

    reader.readAsArrayBuffer(file);
  }

  async function commitBlobData(upload_id, index) {

    console.log("commit start");
    var str_index = String(index);

    //await wait(10);

    var commit_url = push_feature_url + "/uploads/" + upload_id + "/commit";

    var form = new FormData();
    form.set('f','json');
    form.set('token', token);

    $.ajax({
      url: commit_url,
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: true
    }).done(function(data) {
      $('#movie_status_' + str_index).html("送信済");
      $('#movie_upload_id_' + str_index).html(upload_id);

      //入力可に設定
      form_disabled(false);
      console.log(data);

    }).fail(function(data) {
      console.log(data);
    });
  }

  function deleteAllMovieRow() {
    $('#movie_filename_1').html("");
    $('#movie_size_1').html("");
    $('#movie_status_1').html("");
    $('#movie_upload_id_1').html("");
    $('#movie-select1').val("");
    $('#movie_filename_2').html("");
    $('#movie_size_2').html("");
    $('#movie_status_2').html("");
    $('#movie_upload_id_2').html("");
    $('#movie-select2').val("");
    $('#movie_filename_3').html("");
    $('#movie_size_3').html("");
    $('#movie_status_3').html("");
    $('#movie_upload_id_3').html("");
    $('#movie-select3').val("");
  }

  function add_feature(lat, long, flg) {
    form_disabled(true);

    var kbn = 0;
    if (flg == "movie") {
      kbn = 1;
    }
    url = push_feature_url + "/" + layer_id + "/addFeatures";

    var feature = {
      "geometry": {
        "x": long,
        "y": lat,
        "spatialReference" : {"wkid" : 4326}
      },
      "attributes": {
        "KaishaID": $('#kaishaid').val(),
        "Kbn": kbn,
        "Title": $('#title').val(),
        "Naiyo": $('#naiyo').val(),
        "Jusho": $('#jusho').val(),
        "Bikou": $('#bikou').val(),
        "Email": email,
        "Status": 0
      }
    };

    var form = new FormData();
    form.set('f','json');
    form.set('features', JSON.stringify([feature]));
    form.set('token', token);

    $.ajax({
      url: url,
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: false
    }).done(function(data) {
      console.log(data);
      append_attachments(data.addResults[0].objectId, flg);
    }).fail(function(data) {
      console.log(data);
    });
  }

  function append_attachments(oid, flg) {

    var uploads = [];

    //画像ファイル
    if (flg == "image") {
      var objTBL = document.getElementById("imageGallery_tbl");
      var tableRows = objTBL.getElementsByTagName('tr');

      var rowCount = tableRows.length;

      var uploads = [];
      for (var i = 1; i < tableRows.length; i++) {
        uploads.push({
          id: tableRows[i].getElementsByClassName('upload_id')[0].innerText,
          status: 0
        });
      }
      //動画ファイル
    } else {
      var content = $('#movie_upload_id_1');
      if (content.length != 0 && content[0].textContent != "") {
        uploads.push({
          id: content[0].textContent,
          status: 0
        });
      }
      var content = $('#movie_upload_id_2');
      if (content.length != 0 && content[0].textContent != "") {
        uploads.push({
          id: content[0].textContent,
          status: 0
        });
      }
      var content = $('#movie_upload_id_3');
      if (content.length != 0 && content[0].textContent != "") {
        uploads.push({
          id: content[0].textContent,
          status: 0
        });
      }    
    }

    append_attachents(oid, uploads)
  }

  function append_attachents(oid, uploads) {

    var url = push_feature_url + "/" + layer_id + "/" + oid + "/addAttachment";
    var attachment = $('input[name="attachment"]:checked').val();

    append_image_attachents = (uploads, callback) => {
      let count = 0;
      let done = 0;

      let append_image_attachent = async (count) => {
        let upload = uploads[count];

        var form = new FormData();
        var form = new FormData();
        form.set('f','json');
        form.set('uploadId', upload.id);
        form.set('keywords', attachment);
        form.set('token', token);

        var promise = $.ajax({
          url: url,
          type: "POST",
          data: form,
          processData: false,
          contentType: false,
          dataType: 'json',
          async: true
        }).done(function(data) {
          console.log(data);

          uploads[count].status = 1;

          var cnt = 0;
          for (i=0;i<uploads.length;i++) {
            cnt = cnt + uploads[i].status;
          }

          if (cnt == uploads.length) {
            callback();
          }
        }).fail(function(data) {
          console.log(data);
        });

        if (count >= uploads.length - 1) {
          return;
        }
        append_image_attachent(count + 1);
      };
      append_image_attachent(count);
    };

    send_finally = () => {
      //投稿後画面切り替え
      form_disabled(false);
      change_display(3);
      $("html,body").animate({scrollTop:0},"300");

    }

    append_image_attachents(uploads, () => send_finally());
  }

  function append_movie_attachent_upload_id(oid, upload_id) {
    url = push_feature_url + "/" + layer_id + "/" + oid + "/addAttachment";

    var form = new FormData();
    form.set('f','json');
    form.set('uploadId', upload_id);
    form.set('token', token);

    $.ajax({
      url: url,
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: false
    }).done(function(data) {
      console.log(data);
    }).fail(function(data) {
      console.log(data);
    });
  }
  
  function addattachent_upload_file(oid, file) {
    
    if (file.size >= 10 * 1024 *1024) {
      alert("10MB以上のファイルは添付できません");
      return;
    }
    
    var att_html = "<br/>" + file.name + "を追加しています";
    $('#attachmentlistDiv').append(att_html);
    
    url = push_feature_url + "/" + layer_id + "/" + oid + "/addAttachment";

    var form = new FormData();
    form.set('f','json');
    form.set('file', file);
    form.set('token', token);

    $.ajax({
      url: url,
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: true
    }).done(function(data) {
      historyTable.viewattachment(oid);
      console.log(data);
    }).fail(function(data) {
      console.log(data);
    });
  }
  
  function form_clear() {
    form_disabled(false);

    if(navigator.geolocation) {
      locateBtn.locate();
    } else {
      latitude = init_latitude;
      longitude = init_longitude;

      jusho = "";
      $('#jusho').val("");
    }

    $('#title').val("");
    $('#naiyo').val("");
    $('#bikou').val("");
    view.graphics.removeAll();

    $('#gridDiv').html("場所を指定してください");

    deleteAllImageRow();
    deleteAllMovieRow();
    $('#sendbtn').html("送信");
  }
  
  function edit_feature(lat, long) {
    url = push_feature_url + "/" + layer_id + "/updateFeatures";

    var feature = {
      "geometry": {
        "x": long,
        "y": lat,
        "spatialReference" : {"wkid" : 4326}
      },
      "attributes": {
        "OBJECTID": $('#viewobjectid').val(),
        "Title": $('#viewtitle').val(),
        "Naiyo": $('#viewnaiyo').val(),
        "Jusho": $('#viewjusho').val(),
        "Bikou": $('#viewbikou').val()
      }
    };

    var form = new FormData();
    form.set('f','json');
    form.set('features', JSON.stringify([feature]));
    form.set('token', token);

    $.ajax({
      url: url,
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: false
    }).done(function(data) {
      console.log(data);
      //戻る
      $('.returnmenu').click();
    }).fail(function(data) {
      console.log(data);
    });
  }


  const wait = (sec) => {
    return new Promise((resolve, reject) => {
      setTimeout(resolve, sec*1000);
    });
  };

  function form_disabled(disabled) {
    $('input').prop('disabled', disabled);
    $('button').prop('disabled', disabled);
  }
  
  function setActiveWidget(type) {
    switch (type) {
      case "distance":
        activeWidget = new DirectLineMeasurement3D({
          view: sceneview
        });

        activeWidget.viewModel.start();

        view.ui.add(activeWidget, "top-right");
        setActiveButton($('#distanceButton')[0]);
        break;
      case "area":
        activeWidget = new AreaMeasurement3D({
          view: sceneview
        });

        activeWidget.viewModel.start();

        view.ui.add(activeWidget, "top-right");
        setActiveButton($('#areaButton')[0]);
        break;
      case null:
        if (activeWidget) {
          sceneview.ui.remove(activeWidget);
          activeWidget.destroy();
          activeWidget = null;
        }
        break;
    }
  }

  function setActiveButton(selectedButton) {
    view.focus();
    const elements = $('.active');
    for (let i = 0; i < elements.length; i++) {
      elements[i].classList.remove("active");
    }
    if (selectedButton) {
      selectedButton.classList.add("active");
    }
  }

});


function formatDate(date, format) {
  format = format.replace(/yyyy/g, date.getFullYear());
  format = format.replace(/MM/g, ('0' + (date.getMonth() + 1)).slice(-2));
  format = format.replace(/dd/g, ('0' + date.getDate()).slice(-2));
  format = format.replace(/HH/g, ('0' + date.getHours()).slice(-2));
  format = format.replace(/mm/g, ('0' + date.getMinutes()).slice(-2));
  format = format.replace(/ss/g, ('0' + date.getSeconds()).slice(-2));
  format = format.replace(/SSS/g, ('00' + date.getMilliseconds()).slice(-3));
  return format;
};


var historyTable = {
  current_page: 1,
  records_per_page: 10,
  pages: 1,
  records: 0,
  userId: null,
  token: null,
  init: function (userId, token) {
    this.userId = userId;
    this.token = token;
    this.loadHead();
    this.getRecordCount();

    this.changePage(this.current_page);
  },
  loadHead: function () {
    let strRowHead = document.getElementById("tableHead");
    strRowHead.innerHTML = `<tr class="row-head">
          <th>タイトル</th>
          <th>投稿日時</th>
          <th>投稿内容</th>
          <th>住所　　</th>
          <th>備考　　</th>
          <th>確認　　</th>
        </tr>`;
  },

  changePage:function(page) {
    let btn_next = document.getElementById("btn_next");
    let btn_prev = document.getElementById("btn_prev");
    let btn_first = document.getElementById("btn_first");
    let btn_last = document.getElementById("btn_last");

    let page_span = document.getElementById("page");

    if (page < 1) page = 1;
    if (page > this.pages) page = this.pages;
    let tableBody = $("#tableBody");
    tableBody.empty();
    
    if (page == 1) {
      btn_prev.style.visibility = "hidden";
      btn_first.style.visibility = "hidden";
    } else {
      btn_prev.style.visibility = "visible";
      btn_first.style.visibility = "visible";
    }

    if (page == this.numPages()) {
      btn_next.style.visibility = "hidden";
      btn_last.style.visibility = "hidden";
    } else {
      btn_next.style.visibility = "visible";
      btn_last.style.visibility = "visible";
    }

    var form = new FormData();
    form.set('f','json');
    form.set('returnGeometry', false);
    form.set('where', "1=1");
    //form.set('where', creator_field + " = '" + this.userId + "'");
    form.set('outFields', '*');
    form.set('orderByFields', create_date_field + ' DESC');
    form.set('resultOffset', (page -1 ) * this.records_per_page);
    form.set('resultRecordCount', this.records_per_page);
    form.set('token', token);

    $.ajax({
      url: view_feature_url + '/' + layer_id + '/query',
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: false
    }).done(function(data) {
      console.log(data);
      var features = data.features;

      for(var i = 0; i< features.length; i++) {
        var tr_html = "";

        var objectid = features[i].attributes["OBJECTID"];
        var title = features[i].attributes["Title"];
        var createdate = features[i].attributes["CreationDate"];
        var str_createdate = formatDate(new Date(createdate), 'yyyy/MM/dd HH:mm');
        var naiyo = features[i].attributes["Naiyo"];
        var jusho = features[i].attributes["Jusho"];
        var bikou = features[i].attributes["Bikou"];

        tr_html += '<tr>';
        tr_html += '<td data-label="タイトル　">' + title + '　</td>';
        tr_html += '<td data-label="投稿日時　">' + str_createdate + '　</td>';
        tr_html += '<td data-label="投稿内容　">' + naiyo + '　</td>';
        tr_html += '<td data-label="住所　　　">' + jusho + '　</td>';
        tr_html += '<td data-label="備考　　　">' + bikou + '　</td>';
        tr_html += '<td data-label="確認　　　">'
        tr_html += '<input id="view" type="button" value="閲覧" onclick="historyTable.viewForm(' + objectid + ')"/>';
        tr_html += '<input id="del" type="button" value="削除" onclick="historyTable.deleteRow(' + objectid + ')"/>';
        tr_html += '</td>';
        tr_html += '</tr>';

        tableBody.append(tr_html);
      }
    }).fail(function(data) {
      console.log(data);
    });

  },
  prevPage:function() {
    if (this.current_page > 1) {
      this.current_page--;
      this.changePage(this.current_page);
      $('body, html').scrollTop(0);
    }
  },
  nextPage:function() {
    if (this.current_page < this.numPages()) {
      this.current_page++;
      this.changePage(this.current_page);
      $('body, html').scrollTop(0);
    }
  },
  firstPage:function() {
    this.current_page = 1;
    this.changePage(this.current_page);
    $('body, html').scrollTop(0);
  },
  lastPage:function(){
    this.current_page = this.numPages();
    this.changePage(this.current_page);
    $('body, html').scrollTop(0);
  },
  numPages:function() {
    return this.pages;
  },
  viewForm:function(objectid) {
    var form = new FormData();
    form.set('f','json');
    form.set('objectIds', objectid);
    form.set('outFields', '*');
    form.set('outSR', 4326);
    form.set('returnGeometry', true);
    form.set('token', token);

    $.ajax({
      url: view_feature_url + '/' + layer_id + '/query',
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: true,
      context: this,
    }).done(function(data) {
      console.log(data);
      var features = data.features;

      viewview.graphics.removeAll();

      if (features[0].geometry != null) {
        var pointGraphic = {
          geometry: {
            type: "point",
            latitude: features[0].geometry.y,
            longitude: features[0].geometry.x,
            spatialReference: {wkid: 4326}
          }, 
          symbol: markerSymbol
        };
        viewview.graphics.add(pointGraphic);

        viewview.goTo({
          center: [features[0].geometry.x, features[0].geometry.y],
          zoom: 15
        });

        latitude = features[0].geometry.y;
        longitude = features[0].geometry.x;
      }
      
      $('#viewtitle').val(features[0].attributes["Title"]);
      $('#viewnaiyo').val(features[0].attributes["Naiyo"]);
      $('#viewjusho').val(features[0].attributes["Jusho"]);
      $('#viewbikou').val(features[0].attributes["Bikou"]);
      $('#viewobjectid').val(objectid);
      $('#viewscene_itemid').val(features[0].attributes["scene_itemid"]);
      
      this.viewattachment(objectid);
      
      change_display(4);
    }).fail(function(data) {
      console.log(data);
    });
  },
  viewattachment:function(objectid) {
    $('#attachmentlistDiv').html("");
    
    var form = new FormData();
    form.set('f','json');
    form.set('objectIds', objectid);
    //form.set('keywords', 'image,moview');
    form.set('token', token);

    $.ajax({
      url: view_feature_url + '/' + layer_id + '/queryAttachments',
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: true,
      context: this,
    }).done(function(data) {
      console.log(data);
      
      if (data.attachmentGroups.length == 0) {
        return;
      }
      var attachments = data.attachmentGroups[0].attachmentInfos;
      
      var att_html = "";
      
      for(var i = 0; i< attachments.length; i++) {
        var att_name = attachments[i].name;
        var att_id = attachments[i].id;
        var att_url = view_feature_url + '/' + layer_id + '/' + objectid + '/attachments/' + att_id + '?token=' + this.token;
        var contentType = attachments[i].contentType;
        var keywords = attachments[i].keywords;
        
        if (contentType.indexOf('video') !== -1) {
          att_html += att_name + '<br/><video class="view_gallery" src="'+ att_url + '" controls width="100px"></video><br/>';
        } else if (contentType.indexOf('image') !== -1) {
          att_html += att_name + '<br/><img class="view_gallery" src="'+ att_url + '" width="100px"></img><br/>';
        } else if (att_name.indexOf('jpg') !== -1 || att_name.indexOf('png') !== -1 ) {
          att_html += att_name + '<br/><img class="view_gallery" src="'+ att_url + '" width="100px"></img><br/>';
        } else {
          att_html += att_name + '<br/><a target="_blank" rel="noopener noreferrer"  href="'+ att_url + '">ダウンロード</a><br/>';
        } 
        
        att_html += '<input class="delbtn" type="button" id="delBtn' + att_id + '" value="削除" onclick="historyTable.deleteattachent(' + objectid + ', ' + att_id + ')"/>';
        att_html += '<br/><br/>'
      }
      
      $('#attachmentlistDiv').html(att_html);
      
    }).fail(function(data) {
      console.log(data);
    });
  }, 
  deleteattachent:function(oid, attachmentid) {
    url = push_feature_url + "/" + layer_id + "/" + oid + "/deleteAttachments";

    var form = new FormData();
    form.set('f','json');
    form.set('attachmentIds', attachmentid);
    form.set('token', token);

    $.ajax({
      url: url,
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: true
    }).done(function(data) {
      historyTable.viewattachment(oid);
      console.log(data);
    }).fail(function(data) {
      console.log(data);
    });
  },
  deleteRow:function(objectid) {

    if (!window.confirm('削除しますか？')){
      return;
    }

    var form = new FormData();
    form.set('f','json');
    form.set('objectIds', objectid);
    form.set('token', token);

    $.ajax({
      url: view_feature_url + '/' + layer_id + '/deleteFeatures',
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: true,
      context: this,
    }).done(function(data) {
      console.log(data);
      this.refreshRow();
    }).fail(function(data) {
      console.log(data);
    });
  },
  refreshRow:function() {
    this.getRecordCount();
    this.changePage(this.current_page);
  },
  async getRecordCount() {
    var form = new FormData();
    form.set('f','json');
    form.set('where', "1=1");
    //form.set('where', creator_field + " = '" + this.userId + "'");
    form.set('returnGeometry', false);
    form.set('returnCountOnly', true);
    form.set('token', token);

    await $.ajax({
      url: view_feature_url + '/' + layer_id + '/query',
      type: "POST",
      data: form,
      processData: false,
      contentType: false,
      dataType: 'json',
      async: false,
      context: this,
    }).done(function(data) {
      console.log(data);
      this.records = data.count;
      this.pages = Math.ceil(data.count / this.records_per_page);
    }).fail(function(data) {
      console.log(data);
    });
  }
};

function change_display(page) {
  $('body, html').scrollTop(0);
  
  if (page == 1) {  //main
    $('#mainDiv').css('display', 'block');
    $('#formDiv').css('display', 'none');
    $('#completeDiv').css('display', 'none');
    $('#viewformDiv').css('display', 'none');
    $('#helpDiv').css('display', 'none');
  } else if (page == 2) { //form
    $('#mainDiv').css('display', 'none');
    $('#formDiv').css('display', 'block');
    $('#completeDiv').css('display', 'none');
    $('#viewformDiv').css('display', 'none');
    $('#helpDiv').css('display', 'none');
  } else if (page == 3) { //complete
    $('#mainDiv').css('display', 'none');
    $('#formDiv').css('display', 'none');
    $('#completeDiv').css('display', 'block');
    $('#viewformDiv').css('display', 'none');
    $('#helpDiv').css('display', 'none');
  } else if (page == 4) { //viewform
    change_view_enable(false);
    $('#mainDiv').css('display', 'none');
    $('#formDiv').css('display', 'none');
    $('#completeDiv').css('display', 'none');
    $('#viewformDiv').css('display', 'block');
    $('#helpDiv').css('display', 'none');
    
    if ($('#viewscene_itemid').val() == "") {
      $('#making_scene').css('display', 'block');
      $('#viewscene').css('display', 'none');
    } else {
      $('#making_scene').css('display', 'none');
      $('#viewscene').css('display', 'block');
      
      change_viewscene_layer($('#viewscene_itemid').val());
    }
  } else if (page == 9) { //help
    $('#mainDiv').css('display', 'none');
    $('#formDiv').css('display', 'none');
    $('#completeDiv').css('display', 'none');
    $('#viewformDiv').css('display', 'none');
    $('#helpDiv').css('display', 'block');
  }
}

function change_viewscene_layer(item_id) {

  if (item_id == "") return;

  scene.removeAll();

  const Layer = require("esri/layers/Layer");
  const PointCloudLayer = require("esri/layers/PointCloudLayer");
  const IntegratedMeshLayer = require("esri/layers/IntegratedMeshLayer");

  Layer.fromPortalItem({
    portalItem: {
      id: item_id
    }
  }).then(function(layer){
    let sceneLayer = null;
    if (layer.type == "point-cloud") {
      sceneLayer = new PointCloudLayer({
        portalItem: {
          id: item_id
        },
        renderer: {
          type: "point-cloud-rgb",
          field: "RGB",
          pointSizeAlgorithm: {
            type: "fixed-size",
            useRealWorldSymbolSizes: false,
            size: 5
          },
          pointsPerInch: 30
        }
      }); 
    } else if (layer.type == "integrated-mesh") {
      sceneLayer = new IntegratedMeshLayer({
        portalItem: {
          id: item_id
        }
      });
    }
    if (sceneLayer != null) {
      scene.add(sceneLayer);
      
      sceneLayer.when(function(){
        if (sceneLayer.fullExtent) {
          sceneview.clippingEnabled = true;
          sceneview.clippingArea = sceneLayer.fullExtent;
          
          var options = {
            speedFactor: 10,
            easing: "out-quint"
          };
          sceneview.goTo(sceneLayer.fullExtent, options);

          homeButton.viewpoint = {
            targetGeometry: sceneLayer.fullExtent
          };
        }

      });
    }
  });
}


//閲覧ページの編集モード切替
function change_view_enable(flg) {
  if (flg) {
    $('#viewtitle').prop('disabled', false);
    $('#viewnaiyo').prop('disabled', false);
    $('#viewjusho').prop('disabled', false);
    $('#viewbikou').prop('disabled', false);
    $('#editform_show').css('display', 'none');
    $('#edit_send').css('display', 'block');
    $('#edit_cancel').css('display', 'block');
    
    viewview_click = viewview.on("click", function(event){
      var point = event.mapPoint;
      view_graphic_rendar(point.latitude, point.longitude);
    });
    
  } else {
    $('#viewtitle').prop('disabled', true);
    $('#viewnaiyo').prop('disabled', true);
    $('#viewjusho').prop('disabled', true);
    $('#viewbikou').prop('disabled', true);
    $('#editform_show').css('display', 'block');
    $('#edit_send').css('display', 'none');
    $('#edit_cancel').css('display', 'none');
    
    if (viewview_click != null) {
      viewview_click.remove();
    }
  }
  
}

function deleteAllImageRow() {
  var objTBL = document.getElementById("imageGallery_tbl");
  if (!objTBL)
    return;
  var tableRows = objTBL.getElementsByTagName('tr');
  var rowCount = tableRows.length;

  while (objTBL.rows.length > 1) objTBL.deleteRow(-1);

  $('#images_label').html("");
}

function deleteImageRow(obj) {
  if (!obj)
    return;

  var objTR = obj.parentNode.parentNode.parentNode;
  var objTBL = objTR.parentNode.parentNode;

  if (objTBL)
    objTBL.deleteRow(objTR.sectionRowIndex);

  var tagElements = document.getElementsByTagName("span");
  if (!tagElements)
    return false;

  var seq = 1;
  for (var i = 0; i < tagElements.length; i++)
  {
    if (tagElements[i].className.match("seqno"))
      tagElements[i].innerHTML = seq++;
  }

  var tagElements = document.getElementsByTagName("input");
  if (!tagElements)
    return false;

  seq = 1;
  for (var i = 0; i < tagElements.length; i++)
  {
    if (tagElements[i].className.match("delbtn"))
    {
      tagElements[i].setAttribute("id", "delBtn" + seq);
      ++seq;
    }
  }

  $('#images_label').html(objTBL.rows.length-1 + "件の写真が選択されました");
}

//ブラウザバックの禁止
history.pushState(null, null, location.href);
window.addEventListener('popstate', (e) => {
  history.go(1);
});
    </script>

  

</body>

</html>
 
